<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Würzburg interaktiv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet Stylesheet einbinden -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* Layoutstruktur: linke Sidebar + Karte */
    body { margin: 0; display: flex; font-family: sans-serif; }
    #sidebar { width: 300px; height: 100vh; overflow-y: auto; padding: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    #map { flex: 1; height: 100vh; }

    /* Rechte Detailansicht bei Klick auf Marker */
    #detail-view {
      position: fixed; right: 0; top: 0;
      width: 400px; height: 100vh;
      background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      overflow-y: auto; padding: 20px; z-index: 9999;
      display: none;
    }
    #detail-view h2 { margin-top: 0; }
    #detail-view img { max-width: 100%; border-radius: 8px; margin-bottom: 10px; }
    #detail-view iframe { width: 100%; height: 200px; border: none; }

    /* Buttons und Suchfeld */
    .filter-btn { margin: 5px; padding: 6px 12px; background-color: #ddd; border: none; border-radius: 4px; cursor: pointer; }
    .filter-btn.active { background-color: #888; color: #fff; }
    #search { width: 100%; padding: 6px; margin-bottom: 10px; }
    .location-entry { padding: 6px; border-bottom: 1px solid #ccc; cursor: pointer; }
    .location-entry:hover { background-color: #eee; }

    /* Schließen-Button der Detailansicht */
    #detail-close { margin-top: 20px; background: #888; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; }
    .custom-tram-icon { font-size: 20px; }
  </style>
</head>
<body>
  <!-- Linke Seitenleiste -->
  <div id="sidebar">
    <input type="text" id="search" placeholder="Ort suchen...">
    <div id="filter-buttons"></div> <!-- Kategorie-Filter -->
    <div id="linie-buttons"></div>  <!-- Linien-Filter -->
    <div id="location-list"></div>  <!-- Liste aller Orte -->
  </div>

  <!-- Karte -->
  <div id="map"></div>

  <!-- Rechte Detailansicht bei Klick auf Ort -->
  <div id="detail-view">
    <h2 id="detail-title"></h2>
    <img id="detail-image" src="" alt="">
    <p id="detail-description"></p>
    <iframe id="detail-video" src="" allowfullscreen></iframe>
    <button id="detail-close">Schließen</button>
  </div>

  <!-- Leaflet-Bibliothek -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialisierung der Karte auf Würzburg
    const map = L.map('map').setView([49.7942, 9.9301], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap-Mitwirkende'
    }).addTo(map);

    
    // Variablen für Daten und Zustand
    let allFeatures = [], currentLayer, currentCategory = null, currentLinie = null;
    let allCategories = new Set(), allLinien = new Set(), markers = [];

    

    // DOM-Elemente der Detailansicht
    const detailView = document.getElementById('detail-view');
    const detailTitle = document.getElementById('detail-title');
    const detailImage = document.getElementById('detail-image');
    const detailDescription = document.getElementById('detail-description');
    const detailVideo = document.getElementById('detail-video');
    const detailClose = document.getElementById('detail-close');

    // Detailansicht schließen
    detailClose.addEventListener('click', () => detailView.style.display = 'none');

    // Detailansicht anzeigen
    function showDetail(props) {
      detailTitle.textContent = props.title;
      detailDescription.textContent = props.description || "";
      detailImage.src = props.image_url || "";
      detailImage.style.display = props.image_url ? 'block' : 'none';
      detailVideo.src = props.video_url || "";
      detailView.style.display = 'block';
    }

    // Daten aus GeoJSON laden
    fetch('data.geojson')
      .then(response => response.json())
      .then(json => {
        allFeatures = json.features;
        // Alle Kategorien und Linien sammeln
        json.features.forEach(f => {
          allCategories.add(f.properties.category);
          if (f.properties.linie) f.properties.linie.toString().split(',').forEach(l => allLinien.add(l.trim()));
        });

        // Filter-Buttons erzeugen
        const filterDiv = document.getElementById('filter-buttons');
        const linieDiv = document.getElementById('linie-buttons');

        ['Alle', ...allCategories].forEach(cat => {
          const btn = document.createElement('button');
          btn.innerText = cat;
          btn.className = 'filter-btn';
          btn.onclick = () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentCategory = (cat === 'Alle') ? null : cat;
            updateMarkers();
          };
          filterDiv.appendChild(btn);
        });

        ['Alle', ...allLinien].forEach(linie => {
          const btn = document.createElement('button');
          btn.innerText = `Linie ${linie}`;
          btn.className = 'filter-btn';
          btn.onclick = () => {
            document.querySelectorAll('#linie-buttons .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentLinie = (linie === 'Alle') ? null : linie;
            updateMarkers();
          };
          linieDiv.appendChild(btn);
        });

        updateMarkers();
      })
      .catch(err => console.error("Fehler beim Laden von data.geojson:", err));

    // Marker aktualisieren bei Filterung
    function updateMarkers() {
      if (currentLayer) map.removeLayer(currentLayer);
      markers = [];
      document.getElementById('location-list').innerHTML = '';

      // Filter anwenden
      const filtered = allFeatures.filter(f => {
        const matchCategory = currentCategory ? f.properties.category === currentCategory : true;
        const matchLinie = currentLinie ? (f.properties.linie && f.properties.linie.toString().includes(currentLinie)) : true;
        return matchCategory && matchLinie;
      });

      // Marker erzeugen und Listenpunkte erstellen
      currentLayer = L.geoJSON({ type: 'FeatureCollection', features: filtered }, {
        pointToLayer: (feature, latlng) => {
          const linien = (feature.properties.linie || '').split(',');
          const farbe = linien[0]?.trim();
          const icon = linieColors[farbe] ? createTramIcon(linieColors[farbe]) : createTramIcon("gray");
          const marker = L.marker(latlng, { icon });
          markers.push({ title: feature.properties.title, marker });
          return marker;
        },
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          layer.on('click', () => showDetail(props));
          const listItem = document.createElement('div');
          listItem.className = 'location-entry';
          listItem.innerText = props.title;
          listItem.onclick = () => {
            map.setView(layer.getLatLng(), 15);
            layer.openPopup();
            showDetail(props);
          };
          document.getElementById('location-list').appendChild(listItem);
        }
      }).addTo(map);
    }

    // Suchfunktion in der Sidebar
    document.getElementById('search').addEventListener('input', function () {
      const term = this.value.toLowerCase();
      document.querySelectorAll('.location-entry').forEach(item => {
        item.style.display = item.innerText.toLowerCase().includes(term) ? '' : 'none';
      });
    });
  </script>
</body>
</html>
