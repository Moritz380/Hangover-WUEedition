<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>W√ºrzburg interaktiv</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="description" content="Interaktive W√ºrzburg-Karte: Suche & Filter f√ºr Essen, Kultur, Nachtleben & Uni ‚Äì mit Detailansichten, Bildern und Tipps.">
<meta name="robots" content="index,follow, max-image-preview:large">
<link rel="canonical" href="">

<meta property="og:type" content="website">
<meta property="og:site_name" content="W√ºrzburg interaktiv">
<meta property="og:title" content="W√ºrzburg interaktiv">
<meta property="og:description" content="Interaktive W√ºrzburg-Karte: Finde schnell die besten Spots ‚Äì inkl. Suche, Filtern und Detailansichten.">
<meta property="og:url" content="">
<meta property="og:image" content="">
<meta property="og:image:alt" content="Vorschaugrafik der interaktiven W√ºrzburg-Karte">
<meta property="og:locale" content="de_DE">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="W√ºrzburg interaktiv">
<meta name="twitter:description" content="Interaktive W√ºrzburg-Karte mit Suche, Filtern und Detailansichten.">
<meta name="twitter:image" content="">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    html, body {
      height: 100vh;
      margin: 0;
      font-family: sans-serif;
    }

#brand-logos a { display:inline-flex; line-height:0; border-radius:8px; }
#brand-logos a:focus-visible { outline:2px solid #111; outline-offset:2px; }

#brand-logos .brand-logo{
  transition: transform .15s ease, opacity .15s ease;
}

#brand-logos .brand-logo:hover,
#brand-logos a:hover .brand-logo{
  opacity: .9;
  transform: translateY(-1px);
}

    
#cc-splash{
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  background: transparent;
  z-index: 20000;
  pointer-events: none;
}


#cc-splash .cc-logo{
  width: clamp(260px, 60vw, 800px);
  height: auto;
  opacity: 0;
  transform: translateY(6px) scale(.985);
  animation: cc-in .35s cubic-bezier(.2,.8,.2,1) .08s forwards;
  transition:
    opacity 360ms cubic-bezier(.22,.61,.36,1),
    transform 360ms cubic-bezier(.22,.61,.36,1);
  will-change: opacity, transform;
  
  filter: drop-shadow(0 10px 30px rgba(0,0,0,.25));
}


@keyframes cc-in{
  to { opacity: .65; transform: translateY(0) scale(1); }
}

#cc-splash.cc-out .cc-logo{
  opacity: 0;
  transform: translateY(4px) scale(1.005);
}

@media (prefers-reduced-motion: reduce){
  #cc-splash .cc-logo{ animation: none; opacity: .65; transition: none; }
}

    
#map{
  height: 100dvh;
  min-height: 100vh;
  width: 100%;
  position: relative;
  z-index: 1;
}
    
#detail-view{
  position: fixed;
  right: 0;
  top: 0;
  scrollbar-gutter: stable;
  width: var(--panel-target-width);
  box-sizing: border-box;
  height: 100vh;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  box-shadow: -4px 0 20px rgba(0,0,0,0.15);
  overflow-y: auto;
  overflow-x: visible;
  z-index: 13000;
  display: none;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  transform: translateX(100%);
  transition: transform .3s cubic-bezier(0.4,0,0.2,1);
  will-change: width, transform;
}

:root{ --dv-handle-w: 40px; }

#detail-handle{
  position:absolute;
  left: calc(-1 * var(--dv-handle-w));
  top: 40%;
  width: var(--dv-handle-w);
  height: 110px;
  border: 1px solid rgba(0,0,0,.08);
  background: #fff;
  color: #222;
  border-radius: 12px 0 0 12px;
  box-shadow: 0 6px 16px rgba(0,0,0,.2);
  cursor: pointer;
  display: grid;
  place-items: center;
  z-index: 15000;
}

#detail-handle::before{ content:"‚Ä∫"; font-size:26px; line-height:1; }
#detail-view.show #detail-handle::before{ content:"‚Äπ"; }

@media (max-width: 768px){
  #detail-close{ display:none; }
}

    #detail-inner{
      position: relative;
      width: 100%;
      height: auto;
      transform: none;
      transform-origin: initial;
    }

    html { -webkit-text-size-adjust: 100%; }

    #detail-view.show { transform: translateX(0); }
    #detail-view.show #detail-handle::before { content: "‚Äπ"; }

    #detail-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 20px;
      position: relative;
      margin-bottom: 20px;
    }

    #detail-title {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      line-height: 1.3;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #detail-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }
    #detail-close:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }

    #detail-content { padding: 0 20px 20px; }

    #detail-image{
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
      background: #eef1f5;
    }

    .detail-section {
      background: white;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #667eea;
    }
    .detail-section:empty { display: none; }

    .detail-section h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .detail-section p { margin: 0; line-height: 1.5; color: #333; }

    .detail-section.address::before { content: "üìç "; }
    .detail-section.hours::before { content: "üïí "; }
    .detail-section.cost::before { content: "üí∞ "; }
    .detail-section.accessible::before { content: "‚ôø "; }
    .detail-section.tags::before { content: "üè∑Ô∏è "; }

    #detail-video {
      width: 100%;
      height: 200px;
      border: none;
      border-radius: 12px;
      margin-bottom: 15px;
    }

    #detail-view::-webkit-scrollbar { width: 6px; }
    #detail-view::-webkit-scrollbar-track { background: #f1f1f1; }
    #detail-view::-webkit-scrollbar-thumb { background: #667eea; border-radius: 3px; }
    #detail-view::-webkit-scrollbar-thumb:hover { background: #764ba2; }
    
    .category { 
      cursor: pointer; 
      margin-top: 10px;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s ease;
      border: 1px solid #e0e0e0;
      background: #f9f9f9;
      font-size: 13px;
      font-weight: 400;
    }
    .category:hover { background-color: #f0f0f0; border-color: #ccc; transform: translateX(2px); }
    .category.active {
      background-color: #f5f5f5;
      border-color: #999;
      border-left: 4px solid #e63950;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .location-entry { 
      padding: 6px; 
      border-bottom: 1px solid #ccc; 
      cursor: pointer; 
      display: none;
      font-size: 13px;
      font-weight: 400;
    }
    .location-entry:hover { background-color: #eee; }

    #filter-controls {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    #show-all-btn {
      background: #6c757d; color: white; border: none; padding: 6px 12px;
      border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;
    }
    #show-all-btn:hover { background: #5a6268; }
    #show-all-btn.active { background: #495057; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    #filter-toggle {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 10000; background: #e63950; border: none; color: white;
      padding: 8px 16px; border-radius: 12px; font-size: 14px; display: flex;
      align-items: center; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      cursor: pointer; pointer-events: auto; user-select: none; transition: background-color 0.2s ease;
    }
    #filter-toggle:hover { background: #d32f2f; }
    #filter-toggle:focus { outline: 2px solid rgba(230, 57, 80, 0.5); outline-offset: 2px; }
    #filter-toggle svg { width: 20px; height: 20px; fill: white; }

:root{
  --sidebar-width: 420px;
  --sidebar-scale-desktop: .8;
  --sidebar-gutter: 12px;
  --dv-handle-w: 40px;
  --panel-target-width: min(
    calc(var(--sidebar-width) * var(--sidebar-scale-desktop)),
    calc(100vw - var(--sidebar-gutter) - var(--dv-handle-w))
  );
  --sidebar-scale: calc(var(--panel-target-width) / var(--sidebar-width));
  
}

/* Linksverschiebung f√ºr Button + Panel */
:root { --filter-shift: 480px; } /* Wert nach Wunsch anpassen */

#filter-toggle,
#sidebar {
  left: calc(50% - var(--filter-shift)) !important;
}

/* Auf kleinen Screens wieder mittig */
@media (max-width: 768px){
  #filter-toggle, #sidebar { left: 50% !important; }
}

    #sidebar {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      z-index: 999999; width: 320px; max-width: 90vw; background: white; padding: 15px;
      display: none; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      max-height: 70vh; overflow-y: auto;
    }
    #sidebar input[type="text"] {
      width: 100%; padding: 10px 15px; margin-bottom: 15px; border: 1px solid #ddd;
      border-radius: 8px; font-size: 12px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      box-sizing: border-box; transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    #sidebar input[type="text"]:focus {
      outline: none; border-color: #e63950; box-shadow: 0 0 0 3px rgba(230, 57, 80, 0.1);
    }

    #location-list { max-height: 50vh; overflow-y: auto; border-radius: 6px; }

#brand-logos{
  position: fixed;
  left: 12px;
  bottom: calc(env(safe-area-inset-bottom, 0px) + 8px);
  display: flex;
  gap: 12px;
  z-index: 11999;
}
#brand-logos .brand-logo{ height: 96px; width: auto; display: block; }
@media (max-width: 768px){ #brand-logos .brand-logo{ height: 72px; } }
@media (max-width: 480px){ #brand-logos .brand-logo{ height: 56px; } }
@media (max-width: 360px){ #brand-logos .brand-logo{ height: 48px; } }

@media (max-width: 768px){
  #brand-logos{
    flex-direction: column-reverse;
    align-items: flex-start;
    gap: 10px;
    bottom: calc(var(--footer-h, 0px) + env(safe-area-inset-bottom, 0px) + 8px);
  }
}
    footer {
      position: fixed; left: 50%; transform: translateX(-50%); bottom: 8px;
      min-width: unset; max-width: 90vw; padding: 2px 16px;
      background: rgba(240,240,245,0.65); border-radius: 10px;
      box-shadow: 0 2px 8px rgba(40,42,60,0.04); border: none; text-align: center; font-size: 11px;
      display: flex; align-items: center; justify-content: center; gap: 14px; color: #000; z-index: 12000;
      letter-spacing: 0.05em; opacity: 0.85; transition: background 0.2s;
    }
    footer:hover { background: rgba(240,240,245,0.95); }
    footer a {
      color: #000; font-weight: 400; text-decoration: underline dotted; font-size: 11px;
      margin: 0 4px; opacity: 0.9; transition: opacity 0.2s;
    }
    footer a:hover { opacity: 1; color: #000; }

    .leaflet-control-attribution { display: none !important; visibility: hidden !important; opacity: 0 !important; }
    .leaflet-bottom.leaflet-right { display: none !important; }

    #custom-attribution {
      position: fixed !important; bottom: 8px !important; right: 8px !important;
      background: rgba(240,240,245,0.65) !important; color: #000 !important;
      font-size: 11px !important; padding: 3px 10px !important; border-radius: 10px !important;
      z-index: 12000!important; pointer-events: auto !important; opacity: 0.85 !important;
      transition: background 0.2s !important; max-width: none !important; white-space: nowrap !important;
      box-shadow: 0 1px 5px rgba(0,0,0,0.2) !important;
    }
    #custom-attribution:hover { background: rgba(240,240,245,0.95) !important; }
    #custom-attribution a {
      color: #000 !important; text-decoration: underline dotted !important; opacity: 0.9 !important;
      transition: opacity 0.2s !important; margin: 0 2px !important; display: inline-flex !important; align-items: center !important;
    }
    #custom-attribution a:hover { opacity: 1 !important; }
    #custom-attribution svg { margin-right: 4px !important; }

    .leaflet-control-container .leaflet-top.leaflet-left { margin: 10px; }
    .leaflet-control { margin-bottom: 10px !important; border-radius: 4px !important; box-shadow: 0 1px 5px rgba(0,0,0,0.65) !important; border: none !important; }
    .leaflet-control-zoom { background: white !important; }
    .leaflet-control-zoom a {
      width: 30px !important; height: 30px !important; line-height: 30px !important; text-align: center !important;
      background: white !important; color: #333 !important; font-size: 18px !important; font-weight: bold !important; border: none !important;
      border-bottom: 1px solid #ccc !important;
    }
    .leaflet-control-zoom a:hover { background: #f4f4f4 !important; }
    .leaflet-control-zoom-out { border-bottom: none !important; }

    .leaflet-control-layers { background: white !important; padding: 0 !important; min-width: 30px !important; min-height: 30px !important; }
    .leaflet-control-layers-toggle {
      width: 30px !important; height: 30px !important; background: white !important;
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23333' d='M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27L11.99 18.54zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z'/%3E%3C/svg%3E") !important;
      background-size: 18px 18px !important; background-position: center !important; background-repeat: no-repeat !important; border: none !important;
    }
    .leaflet-control-layers-toggle:hover { background-color: #f4f4f4 !important; }
    .leaflet-control-layers-list {
      background: white !important; box-shadow: 0 1px 5px rgba(0,0,0,0.65) !important; border-radius: 4px !important;
      padding: 8px !important; margin-top: 2px !important; min-width: 120px !important;
    }
    .leaflet-control-layers-list label { font-size: 12px !important; margin: 4px 0 !important; cursor: pointer !important; display: block !important; }

    .leaflet-control-lang {
  background: white !important;
  width: 30px !important;
  border-radius: 4px !important;
  box-shadow: 0 1px 5px rgba(0,0,0,0.65) !important;
}

.leaflet-control-lang a {
  display: block;
  width: 30px !important;
  height: 30px !important;
  line-height: 30px !important;
  text-align: center !important;
  background: white !important;
  color: #333 !important;
  font-size: 12px !important;
  font-weight: 700 !important;
  border: none !important;
  border-bottom: 1px solid #ccc !important;
  text-decoration: none !important;
  cursor: pointer !important;
}

.leaflet-control-lang a:last-child {
  border-bottom: none !important;
}

.leaflet-control-lang a.active {
  background: #111 !important;
  color: #fff !important;
}

    .leaflet-control-fullscreen { background: white !important; width: 30px !important; height: 30px !important; }
    .leaflet-control-fullscreen-button {
      width: 30px !important; height: 30px !important; background: white !important;
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23333' d='M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z'/%3E%3C/svg%3E") !important;
      background-size: 18px 18px !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      border: none !important;
    }

    .leaflet-control-fullscreen-button:hover {
      background-color: #f4f4f4 !important;
    }

    .leaflet-control-location {
      background: white !important;
      width: 30px !important;
      height: 30px !important;
      border-radius: 4px !important;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65) !important;
    }

    .leaflet-control-location-button {
      width: 30px !important;
      height: 30px !important;
      background: white !important;
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23333' d='M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0 0 13 3.06V1h-2v2.06A8.994 8.994 0 0 0 3.06 11H1v2h2.06A8.994 8.994 0 0 0 11 20.94V23h2v-2.06A8.994 8.994 0 0 0 20.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z'/%3E%3C/svg%3E") !important;
      background-size: 18px 18px !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      border: none !important;
      border-radius: 4px !important;
    }

    .leaflet-control-location-button:hover { background-color: #f4f4f4 !important; }

@media (max-width: 768px){
  :root { --sidebar-gutter: 0px; }
  #sidebar { width: 95vw; max-width: 95vw; }
  #filter-toggle { padding: 10px 16px; font-size: 14px; z-index: 8000 !important; }
  footer { font-size: 9px; padding: 2px 8px; bottom: 35px !important; max-width: 80vw; gap: 8px; }
  #custom-attribution { font-size: 8px !important; padding: 2px 6px !important; bottom: 8px !important; right: 4px !important; }
}
  </style>
</head>
<body>

<div id="cc-splash" aria-hidden="true">
  <img src="./assets/logo.png" alt="" class="cc-logo">
</div>

<button id="filter-toggle" onclick="toggleFilterSidebar()" tabindex="0" 
        title="Suchen / Filtern" aria-expanded="false" aria-controls="sidebar">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30">
    <path d="M16.7,26.9c-0.2,0-0.4-0.1-0.6-0.2l-2.7-1.9c-0.5-0.4-0.9-1.1-0.9-1.7v-6.1c0-0.3-0.2-0.9-0.4-1.1L2.4,4.6C2,4.1,2.1,3.8,2.2,3.6c0.1-0.1,0.3-0.5,0.9-0.5h23.8c0.6,0,0.8,0.3,0.9,0.5c0.1,0.1,0.2,0.5-0.2,1v0l-9.7,11.2c-0.2,0.3-0.4,0.8-0.4,1.1v9c0,0.4-0.2,0.7-0.5,0.9C16.9,26.8,16.8,26.9,16.7,26.9z M3.4,4.1l9.5,11c0.4,0.4,0.7,1.2,0.7,1.8V23c0,0.3,0.2,0.7,0.5,0.9l2.5,1.8l0-8.8c0-0.6,0.3-1.3,0.7-1.8l9.5-11L3.4,4.1z"></path>
  </svg>
  <span>Suchen / Filtern</span>
</button>

<div id="main">
  <div id="sidebar">
    <div id="filter-controls">
      <button id="show-all-btn" class="active" onclick="showAllMarkersAndClose()">Alle anzeigen</button>
    </div>
    
    <input type="text" id="search" placeholder="Ort suchen..." 
           aria-label="Suchfeld f√ºr Orte">
    <div id="location-list" role="list"></div>
  </div>

  <div id="map"></div>
  <div id="brand-logos" aria-label="Logos">
  <a href="https://instagram.com/catching_card"
     target="_blank" rel="noopener noreferrer"
     data-title-de="Zum Instagram-Kanal von Catching Cards"
     data-title-en="Go to Catching Cards on Instagram"
     title="Zum Instagram-Kanal von Catching Cards"
     aria-label="Zum Instagram-Kanal von Catching Cards">
    <img src="./assets/logo.png" alt="Catching Card" class="brand-logo">
  </a>

  <a href="https://www.mcm.uni-wuerzburg.de/mp/"
     target="_blank" rel="noopener noreferrer"
     data-title-de="Zur Website der Medienpsychologie"
     data-title-en="Go to the Media Psychology website"
     title="Zur Website der Medienpsychologie"
     aria-label="Zur Website der Medienpsychologie">
    <img src="./assets/mp.png" alt="Medienpsychologie" class="brand-logo">
  </a>
</div>


  <div id="detail-view" role="dialog" aria-labelledby="detail-title">
    <button id="detail-handle" aria-label="Detailansicht schlie√üen"></button>
    <div id="detail-inner">
      <div id="detail-header">
        <h2 id="detail-title"></h2>
        <button id="detail-close" tabindex="0" aria-label="Detailansicht schlie√üen">&times;</button>
      </div>

      <div id="detail-content">
        <img id="detail-image"
             loading="lazy"
             decoding="async"
             width="960"
             height="540"
             alt="">
        <iframe id="detail-video" src="" allowfullscreen style="display:none;"></iframe>

        <div id="detail-description" class="detail-section description"></div>
        <div id="detail-address"     class="detail-section address"></div>
        <div id="detail-opening"     class="detail-section hours"></div>
        <div id="detail-cost"        class="detail-section cost"></div>
        <div id="detail-accessible"  class="detail-section accessible"></div>
        <div id="detail-tags"        class="detail-section tags"></div>
      </div>
    </div>
  </div>
</div>

<footer>
  <a href="impressum.html">Impressum</a>
  <span aria-hidden="true">|</span>
  <a href="datenschutzerklaerung.html">Datenschutzerkl√§rung</a>
</footer>

<script>
  const I18N = {
    de: {
      lang: { de: "Deutsch", en: "Englisch" },
      filter: { label: "Suchen / Filtern", title: "Suchen / Filtern", showAll: "Alle anzeigen" },
      search: { placeholder: "Ort suchen...", aria: "Suchfeld f√ºr Orte" },
      fullscreen: { title: "Vollbildmodus" },
      geo: {
        title: "Standort ermitteln",
        unsupported: "Standortbestimmung wird von diesem Browser nicht unterst√ºtzt.",
        failed: "Standort konnte nicht bestimmt werden.",
        here: "Du bist hier!"
      },
      details: {
        description: "Beschreibung",
        address: "Adresse",
        opening: "√ñffnungszeiten",
        cost: "Kosten",
        accessible: "Barrierefreiheit",
        tags: "Tags",
        untitled: "(Kein Titel)",
        close: "Detailansicht schlie√üen"
      },
      baselayer: {
        map: "Karte",
        satellite: "Luftbild",
        attr_osm: "¬© OpenStreetMap-Mitwirkende",
        attr_sat: "Bilddaten: Esri, Earthstar Geographics, OpenStreetMap"
      },
      footer: { imprint: "Impressum", privacy: "Datenschutzerkl√§rung" }
    },
    en: {
      lang: { de: "German", en: "English" },
      filter: { label: "Search / Filter", title: "Search / Filter", showAll: "Show all" },
      search: { placeholder: "Search place...", aria: "Search field for places" },
      fullscreen: { title: "Fullscreen" },
      geo: {
        title: "Locate me",
        unsupported: "Geolocation is not supported by this browser.",
        failed: "Couldn‚Äôt get your location.",
        here: "You‚Äôre here!"
      },
      details: {
        description: "Description",
        address: "Address",
        opening: "Opening hours",
        cost: "Costs",
        accessible: "Accessibility",
        tags: "Tags",
        untitled: "(No title)",
        close: "Close detail view"
      },
      baselayer: {
        map: "Map",
        satellite: "Satellite",
        attr_osm: "¬© OpenStreetMap contributors",
        attr_sat: "Imagery: Esri, Earthstar Geographics, OpenStreetMap"
      },
      footer: { imprint: "Imprint", privacy: "Privacy policy" }
    }
  };

  let LANG = localStorage.getItem("ui_lang") ||
             (((navigator.language || "").toLowerCase().startsWith("de")) ? "de" : "en");
  if (LANG !== "de" && LANG !== "en") LANG = "de";

  function t(path) {
    const parts = path.split(".");
    let cur = I18N[LANG];
    for (const p of parts) {
      if (!cur || typeof cur !== "object" || !(p in cur)) return path;
      cur = cur[p];
    }
    return cur;
  }

function applyLogoTitles() {
  const lang = (document.documentElement.lang || 'de').slice(0, 2);
  const key  = lang === 'en' ? 'titleEn' : 'titleDe';
  document.querySelectorAll('#brand-logos a').forEach(a => {
    const newTitle = a.dataset[key];
    if (newTitle) {
      a.title = newTitle;                    
      a.setAttribute('aria-label', newTitle);
    }
  });
}

function updateUIStrings() {
  document.documentElement.lang = LANG;

  const ft = document.getElementById("filter-toggle");
  if (ft) {
    ft.setAttribute("title", t("filter.title"));
    ft.querySelector("span")?.replaceChildren(document.createTextNode(t("filter.label")));
  }

  const showAllBtn = document.getElementById("show-all-btn");
  if (showAllBtn) showAllBtn.textContent = t("filter.showAll");

  const search = document.getElementById("search");
  if (search) {
    search.placeholder = t("search.placeholder");
    search.setAttribute("aria-label", t("search.aria"));
  }

  const geoBtn = document.querySelector(".leaflet-control-location-button");
  if (geoBtn) {
    geoBtn.setAttribute("title", t("geo.title"));
    geoBtn.setAttribute("aria-label", t("geo.title"));
  }

  const fsBtn = document.querySelector(".leaflet-control-fullscreen-button");
  if (fsBtn) fsBtn.setAttribute("title", t("fullscreen.title"));

  document.getElementById("btn-lang-de")?.classList.toggle("active", LANG === "de");
  document.getElementById("btn-lang-en")?.classList.toggle("active", LANG === "en");

  refreshAttribution();

  const footer = document.querySelector("footer");
  if (footer) {
    const links = footer.querySelectorAll("a");
    if (links[0]) {
      links[0].textContent = t("footer.imprint");
      links[0].setAttribute("aria-label", t("footer.imprint"));
    }
    if (links[1]) {
      links[1].textContent = t("footer.privacy");
      links[1].setAttribute("aria-label", t("footer.privacy"));
    }
  }

  const closeLabel = t("details.close");
  const closeBtnEl = document.getElementById("detail-close");
  if (closeBtnEl) {
    closeBtnEl.setAttribute("aria-label", closeLabel);
    closeBtnEl.setAttribute("title", closeLabel);
  }
  const handleEl = document.getElementById("detail-handle");
  if (handleEl) {
    handleEl.setAttribute("aria-label", closeLabel);
    handleEl.setAttribute("title", closeLabel);
  }

  applyLogoTitles();
  refreshMarkerTitles();
}

function refreshMarkerTitles() {
  if (!currentLayer) return;
  currentLayer.eachLayer(layer => {
    const title = pickLang(layer.feature?.properties, "name") || t("details.untitled");
    layer.options.title = title;
    const el = (layer.getElement && layer.getElement()) || layer._icon;
    if (el) el.title = title; // nativer Tooltip wie beim Zoom
  });
}

function setLang(code) {
  if (!I18N[code]) return;
  LANG = code;
  localStorage.setItem("ui_lang", code);
  updateUIStrings();
  translateOpenUI();

  function translateOpenUI() {
    if (detailView && detailView.style.display === 'block' && lastDetailProps) {
      showDetail(lastDetailProps);
    }

    const container = document.getElementById('location-list');
    if (!container) return;

    const openCats = new Set(
      Array.from(container.querySelectorAll('.category.active')).map(el => el.dataset.category)
    );
    const scrollTop = container.scrollTop;

    buildCategoryList(); // einmal neu aufbauen (neue Labels)

    container.querySelectorAll('.category').forEach(cat => {
      if (openCats.has(cat.dataset.category)) {
        cat.classList.add('active');
        cat.querySelectorAll('.location-entry').forEach(e => { e.style.display = 'block'; });
      }
    });
    container.scrollTop = scrollTop;
    applyMapFilter();
  }
}
    function h3(key) { return '<h3>' + t('details.' + key) + '</h3>'; }

    function pickLang(props, base) { if (!props) return ""; const v = props[base + "_" + LANG]; if (v && String(v).trim()) return v; return props[base] || ""; }

  function refreshAttribution(usingSatellite) {
    const el = document.getElementById("current-attribution");
    if (!el) return;
    if (usingSatellite === true) {
      el.innerHTML = t("baselayer.attr_sat")
        .replace("Esri", '<a href="https://www.esri.com/en-us/home">Esri</a>')
        .replace("OpenStreetMap", '<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>');
    } else {
      el.innerHTML = t("baselayer.attr_osm")
        .replace("OpenStreetMap", '<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>');
    }
  }

  function setFooterVar(){
    const f = document.querySelector('footer');
    const cs = f ? getComputedStyle(f) : null;
    const bottom = cs ? parseFloat(cs.bottom) || 0 : 0;
    const height = f ? f.offsetHeight : 0;
    const clearance = bottom + height + 8;
    document.documentElement.style.setProperty('--footer-h', clearance + 'px');
  }
  window.addEventListener('load', setFooterVar);
  window.addEventListener('resize', setFooterVar);
</script>

<div id="custom-attribution">
  <a href="https://leafletjs.com" title="A JavaScript library for interactive maps">
    <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8">
      <path fill="#4C7BE1" d="M0 0h12v4H0z"></path>
      <path fill="#FFD500" d="M0 4h12v3H0z"></path>
      <path fill="#E0BC00" d="M0 7h12v1H0z"></path>
    </svg> Leaflet
  </a>
  | <span id="current-attribution">¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap-Mitwirkende</a></span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>

<script>
let allFeatures = [];
let currentLayer = null;
let grouped = {};
let lastDetailProps = null;

// --- Helfer: Strings normieren (Trim, doppelte Spaces raus, Unicode normalisieren)
function norm(s){ return String(s||'').normalize('NFKC').replace(/\s+/g,' ').trim(); }

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

let searchTerm = "";

function setMarkersFor(features) {
  if (currentLayer) { currentLayer.off(); map.removeLayer(currentLayer); }
  currentLayer = L.geoJSON({ type: "FeatureCollection", features }, {
    pointToLayer: (f, latlng) => L.marker(latlng, {
      title: pickLang(f.properties, "name") || t("details.untitled")
    }),
    onEachFeature: (f, layer) => layer.on("click", () => showDetail(f.properties))
  }).addTo(map);

  refreshMarkerTitles(); // wichtig
}

// 7 kanonische Kategorien (Schl√ºssel + Labels + einfache Synonyme)
const CATS = [
  { key:'food',      de:'Essen & Trinken',             en:'Food & Drink',
    match:['essen','trinken','food','drink','bar','bars','cafe','caf√©','restaurant'] },
  { key:'sport',     de:'Sport & Aktivit√§t',           en:'Sports & Activities',
    match:['sport','aktivit√§t','activity','activities','freizeit','outdoor'] },
  { key:'social',    de:'Unterhaltung & Begegnung',    en:'Social & Meetups',
    match:['unterhaltung','begegnung','social','meetup','treffpunkt'] },
  { key:'culture',   de:'Kultur & Sehensw√ºrdigkeiten', en:'Culture & Sights',
    match:['kultur','sehensw√ºrd','museum','theater','sight'] },
  { key:'events',    de:'Events & Festivals',          en:'Events & Festivals',
    match:['event','events','festival','festivals','veranstalt'] },
  { key:'nightlife', de:'Ausgehen & Nachtleben',       en:'Nightlife / Food & Drink',
    match:['nachtleben','nightlife','ausgehen','club','party'] },
  { key:'uni',       de:'Universit√§t & Studium',       en:'University & Studies',
    match:['universit√§t','uni','studium','university','study','campus'] },
];

const LABEL = (key) => {
  const c = CATS.find(c=>c.key===key);
  return LANG==='en' ? c.en : c.de;
};

// explizite Mehrfachzuordnung per Name (normiert)
const MULTI_CAT_OVERRIDE = new Map([
  [norm('Wohnzimmer Bar'),      ['food','nightlife']],
  [norm('Waldsch√§nke Dornheim'),['food','nightlife']],
]);

function categoriesForFeature(props){
  if (!props) return [];
  const nameKey = norm(props.name || props.name_de || props.name_en);
  if (MULTI_CAT_OVERRIDE.has(nameKey)) return MULTI_CAT_OVERRIDE.get(nameKey);

  const raw = norm(props.category).toLowerCase();
  if (!raw) return [];
  const parts = raw.split(/[\/|,&;]+/g).map(s=>s.trim()).filter(Boolean);

  const keys = new Set();
  for (const part of parts){
    for (const c of CATS){
      if (c.match.some(m => part.includes(m))) keys.add(c.key);
    }
  }
  return [...keys];
}

function applyMapFilter() {
  const activeKeys = Array.from(document.querySelectorAll('.category.active'))
    .map(el => el.dataset.category);

  const term = (searchTerm || "").toLowerCase().trim();

  const filtered = allFeatures.filter(f => {
    const p = f.properties || {};
    const names = [p.name, p.name_de, p.name_en].filter(Boolean).map(s => String(s).toLowerCase());
    const inSearch = !term || names.some(n => n.includes(term));

    const keys = categoriesForFeature(p);
    const inCat = !activeKeys.length || keys.some(k => activeKeys.includes(k));

    return inSearch && inCat;
  });

  setMarkersFor(filtered);
}

function toggleFilterSidebar() {
  const sidebar = document.getElementById('sidebar');
  const filterButton = document.getElementById('filter-toggle');
  
  if (sidebar.style.display === 'block') {
    resetSearchResults();
    sidebar.style.display = 'none';
    filterButton.setAttribute('aria-expanded', 'false');
  } else {
    sidebar.style.display = 'block';
    filterButton.setAttribute('aria-expanded', 'true');
    document.getElementById('search').focus();
  }
}

function resetSearchResults() {
  document.getElementById('search').value = '';
  document.querySelectorAll('.category').forEach(category => {
    category.style.display = 'block';
    category.classList.remove('active');
  });
  document.querySelectorAll('.location-entry').forEach(entry => {
    entry.style.display = 'none';
  });
  document.getElementById('show-all-btn').classList.add('active');
}

function resetSidebarState() {
  document.querySelectorAll('.category').forEach(category => {
    category.classList.remove('active');
  });
  document.querySelectorAll('.location-entry').forEach(entry => {
    entry.style.display = 'none';
  });
  document.getElementById('show-all-btn').classList.add('active');
}

function showAllMarkersAndClose() {
  if (currentLayer && allFeatures.length > 0) {
  
    searchTerm = "";
    const input = document.getElementById('search');
    if (input) input.value = "";
    document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));

    applyMapFilter();
    const group = L.featureGroup(currentLayer.getLayers());
    if (group.getLayers().length) {
      map.fitBounds(group.getBounds(), { padding: [20, 20] });
    }
  }
  setTimeout(() => {
    document.getElementById('sidebar').style.display = 'none';
    document.getElementById('filter-toggle').setAttribute('aria-expanded', 'false');
  }, 300);
}

document.addEventListener('click', function(e) {
  const sidebar = document.getElementById('sidebar');
  const filterButton = document.getElementById('filter-toggle');
  if (!filterButton.contains(e.target) && !sidebar.contains(e.target)) {
    if (sidebar.style.display === 'block') {
      resetSearchResults();
      sidebar.style.display = 'none';
      filterButton.setAttribute('aria-expanded', 'false');
    }
  }
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const sidebar = document.getElementById('sidebar');
    const detailView = document.getElementById('detail-view');
    const filterButton = document.getElementById('filter-toggle');
    
    if (sidebar.style.display === 'block') {
      resetSearchResults();
      sidebar.style.display = 'none';
      filterButton.setAttribute('aria-expanded', 'false');
    }
    if (detailView.style.display === 'block') {
      detailView.classList.remove('show');
      setTimeout(() => { detailView.style.display = 'none'; }, 300);
    }
  }
});

const map = L.map('map', {
  fullscreenControl: false,
  attributionControl: false,
  zoomControl: true
}).setView([49.7942, 9.9301], 13);

const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: ''
});

const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 20,
  attribution: ''
});

osmLayer.addTo(map);

map.on('baselayerchange', function(e) {
  const isSat = (e.layer === satelliteLayer);
  refreshAttribution(isSat);
});

map.whenReady(function() {
  const layerControl = L.control.layers(
    { [t("baselayer.map")]: osmLayer, [t("baselayer.satellite")]: satelliteLayer },
    undefined,
    { position: 'topleft', collapsed: true, autoZIndex: true }
  );
  layerControl.addTo(map);

  try {
    if (typeof L.Control.Fullscreen !== 'undefined') {
      const fullscreenControl = new L.Control.Fullscreen({ position: 'topleft', forceSeparateButton: true });
      map.addControl(fullscreenControl);
    } else {
      createFallbackFullscreenButton();
    }
  } catch(error) {
    createFallbackFullscreenButton();
  }

  try {
    const LocationControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function() {
        const div = L.DomUtil.create('div', 'leaflet-control-location leaflet-bar leaflet-control');
        const btn = L.DomUtil.create('a', 'leaflet-control-location-button leaflet-bar-part', div);
        btn.href = '#';
        btn.title = t('geo.title');
        btn.setAttribute('role', 'button');
        btn.setAttribute('aria-label', t('geo.title'));
        
        L.DomEvent.on(btn, 'click', function (e) {
          L.DomEvent.stopPropagation(e);
          L.DomEvent.preventDefault(e);
          
          if (!navigator.geolocation) {
            alert(t('geo.unsupported'));
            return;
          }
          
          btn.style.opacity = '0.5';
          
          navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords;
            L.marker([latitude, longitude]).addTo(map)
              .bindPopup(t("geo.here"))
              .openPopup();
            map.setView([latitude, longitude], 16);
            btn.style.opacity = '1';
          }, (error) => {
            console.error('Geolocation error:', error);
            alert(t('geo.failed'));
            btn.style.opacity = '1';
          });
        });
        
        L.DomEvent.disableClickPropagation(div);
        return div;
      },
      onRemove: function() {}
    });
    
    map.addControl(new LocationControl());

    const LanguageControl = L.Control.extend({
      options: { position: 'topleft' },
      onAdd: function () {
        const div = L.DomUtil.create('div', 'leaflet-control-lang leaflet-bar leaflet-control');

        const btnDE = L.DomUtil.create('a', 'leaflet-bar-part', div);
        btnDE.id = 'btn-lang-de';
        btnDE.href = '#';
        btnDE.textContent = 'DE';
        btnDE.title = 'Deutsch';
        btnDE.setAttribute('aria-label', 'Deutsch');
        L.DomEvent.on(btnDE, 'click', (e) => { L.DomEvent.stop(e); setLang('de'); });

        const btnEN = L.DomUtil.create('a', 'leaflet-bar-part', div);
        btnEN.id = 'btn-lang-en';
        btnEN.href = '#';
        btnEN.textContent = 'EN';
        btnEN.title = 'English';
        btnEN.setAttribute('aria-label', 'English');
        L.DomEvent.on(btnEN, 'click', (e) => { L.DomEvent.stop(e); setLang('en'); });

        L.DomEvent.disableClickPropagation(div);
        return div;
      }
    });

    map.addControl(new LanguageControl());

    updateUIStrings();
    refreshAttribution(false);
    
  } catch(error) {
    console.error('Location/Language-Control Fehler:', error);
  }
});

function createFallbackFullscreenButton() {
  const FallbackFullscreen = L.Control.extend({
    onAdd: function() {
      const div = L.DomUtil.create('div', 'leaflet-control-fullscreen leaflet-bar leaflet-control');
      const btn = L.DomUtil.create('a', 'leaflet-control-fullscreen-button leaflet-bar-part', div);
      btn.href = '#';
      btn.title = t('fullscreen.title');
      
      L.DomEvent.on(btn, 'click', function (e) {
        L.DomEvent.stopPropagation(e);
        L.DomEvent.preventDefault(e);
        try {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else {
            document.documentElement.requestFullscreen();
          }
        } catch(error) {
          console.error('Fullscreen error:', error);
        }
      });
      
      L.DomEvent.disableClickPropagation(div);
      return div;
    }
  });
  
  map.addControl(new FallbackFullscreen({ position: 'topleft' }));
}

const detailView = document.getElementById('detail-view');
const detailTitle = document.getElementById('detail-title');
const detailImage = document.getElementById('detail-image');
const detailAddress = document.getElementById('detail-address');
const detailDescription = document.getElementById('detail-description');
const detailOpening = document.getElementById('detail-opening');
const detailCost = document.getElementById('detail-cost');
const detailAccessible = document.getElementById('detail-accessible');
const detailTags = document.getElementById('detail-tags');
const detailVideo = document.getElementById('detail-video');

const detailHandle = document.getElementById('detail-handle');

function closeDetail(){
  detailView.classList.remove('show');
  setTimeout(() => { detailView.style.display = 'none'; }, 300);
}

document.getElementById('detail-close')?.addEventListener('click', closeDetail);
detailHandle?.addEventListener('click', closeDetail);

let startX=null, startY=null;
detailView.addEventListener('touchstart', e => {
  const t = e.touches[0]; startX = t.clientX; startY = t.clientY;
}, {passive:true});

detailView.addEventListener('touchend', e => {
  if(startX===null) return;
  const t = e.changedTouches[0];
  const dx = t.clientX - startX, dy = t.clientY - startY;
  if(Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) && dx > 0){
    closeDetail();
  }
  startX=null; startY=null;
}, {passive:true});


function showDetail(props) { lastDetailProps = props;
  detailTitle.textContent = pickLang(props, "name") || t("details.untitled");

  const desc = pickLang(props, "description");
  detailDescription.innerHTML = desc ? h3("description") + "<p>" + desc + "</p>" : "";

  const addr = pickLang(props, "address");
  detailAddress.innerHTML = addr ? h3("address") + "<p>" + addr + "</p>" : "";

  const oh = pickLang(props, "opening_hours");
  if (oh) {
    const lines = String(oh)
      .split(/[,;]\s*|\n+/)
      .map(s => s.trim())
      .filter(Boolean)
      .join("<br>");
    detailOpening.innerHTML = h3("opening") + "<p>" + lines + "</p>";
  } else {
    detailOpening.innerHTML = "";
  }

  const cost = pickLang(props, "cost");
  detailCost.innerHTML = cost ? h3("cost") + "<p>" + cost + "</p>" : "";

  const acc = pickLang(props, "accessible");
  detailAccessible.innerHTML = acc ? h3("accessible") + "<p>" + acc + "</p>" : "";

  const tags = pickLang(props, "tags");
  detailTags.innerHTML = tags ? h3("tags") + "<p>" + tags + "</p>" : "";

  if (props.image_url) {
    detailImage.classList.remove("loaded");
    if (detailImage.src !== props.image_url) {
      detailImage.onload = () => detailImage.classList.add("loaded");
      detailImage.onerror = () => {
        detailImage.classList.remove("loaded");
        detailImage.removeAttribute("src");
      };
      detailImage.src = props.image_url;
    }
    detailImage.alt = props.name ? "Foto: " + props.name : "Foto";
  } else {
    detailImage.classList.remove("loaded");
    detailImage.removeAttribute("src");
    detailImage.alt = "";
  }

  if (props.video_url) {
    if (detailVideo.src !== props.video_url) detailVideo.src = props.video_url;
    detailVideo.style.display = "block";
  } else {
    detailVideo.style.display = "none";
    try { detailVideo.src = ""; } catch (_) {}
  }

  detailView.style.display = "block";
  setTimeout(() => {
    scrollDetailToTop();
    detailView.classList.add("show");
  }, 10);

  resetSidebarState();
}

function scrollDetailToTop() {
  detailView.scrollTop = 0;
  try { detailView.scrollTo({ top: 0, behavior: 'smooth' }); } catch (_) {}
}

function updateMarkers() {
  setMarkersFor(allFeatures);
  }

function buildCategoryList() {
  const container = document.getElementById('location-list');
  container.innerHTML = '';

  const groups = {};
  for (const f of allFeatures) {
    const keys = categoriesForFeature(f.properties);
    const list = keys.length ? keys : []; // ohne Treffer weglassen oder ggf. 'other'
    for (const k of list) (groups[k] ||= []).push(f);
  }

  for (const cat of CATS) {
    const arr = groups[cat.key];
    if (!arr || !arr.length) continue;

    const catDiv = document.createElement('div');
    catDiv.className = 'category';
    catDiv.dataset.category = cat.key;
    catDiv.textContent = LABEL(cat.key);
    container.appendChild(catDiv);

    arr.sort((a,b) => (pickLang(a.properties,'name')||'').localeCompare(pickLang(b.properties,'name')||''));
    for (const f of arr) {
      const locDiv = document.createElement('div');
      locDiv.className = 'location-entry';
      locDiv.textContent = pickLang(f.properties, "name") || "Unbekannter Ort";
      locDiv.addEventListener('click', () => {
        if (f.geometry?.coordinates) {
          map.setView([f.geometry.coordinates[1], f.geometry.coordinates[0]], 18);
          showDetail(f.properties);
          document.getElementById('sidebar').style.display = 'none';
          document.getElementById('filter-toggle').setAttribute('aria-expanded', 'false');
        }
      });
      catDiv.appendChild(locDiv);
    }

    catDiv.addEventListener('click', (e) => {
      if (e.target.classList.contains('location-entry')) return;
      const open = !catDiv.classList.contains('active');
      document.querySelectorAll('.category').forEach(other => {
        other.classList.remove('active');
        other.querySelectorAll('.location-entry').forEach(entry => entry.style.display = 'none');
      });
      if (open) {
        catDiv.classList.add('active');
        catDiv.querySelectorAll('.location-entry').forEach(entry => entry.style.display = 'block');
      }
      applyMapFilter();
    });
  }
}


function slugify(str) {
  return (str || '')
    .toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/^-+|-+$/g,'')
    .slice(0,80);
}

function injectPlacesJSONLD(features, maxItems = 500) {
  if (!Array.isArray(features) || !features.length) return;

  const canonical = document.querySelector('link[rel="canonical"]')?.href || location.href;
  const baseUrl = canonical.replace(/#.*$/, '');

  const sorted = [...features].sort((a,b) => {
    const an = (a?.properties?.name || '').toLocaleLowerCase();
    const bn = (b?.properties?.name || '').toLocaleLowerCase();
    return an.localeCompare(bn);
  }).slice(0, maxItems);

  const itemListElement = sorted.map((f, i) => {
    const p = f?.properties || {};
    const [lng, lat] = f?.geometry?.coordinates || [];
    const slug = slugify(p.name || `${lat}-${lng}`);
    const url = baseUrl + '#place-' + slug;

    const place = { "@type": "Place", "name": p.name || "Unbekannter Ort", "url": url };
    if (p.address) place.address = p.address;
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
      place.geo = { "@type": "GeoCoordinates", latitude: lat, longitude: lng };
    }
    if (p.category) place.additionalType = p.category;
    if (p.description) place.description = p.description;

    return { "@type": "ListItem", position: i + 1, item: place };
  });

  const jsonLd = {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "ItemList",
        "@id": baseUrl + "#places",
        "name": "Orte in W√ºrzburg interaktiv",
        "itemListElement": itemListElement
      }
    ]
  };

  const s = document.createElement('script');
  s.type = 'application/ld+json';
  s.textContent = JSON.stringify(jsonLd);
  document.head.appendChild(s);
}

fetch('data.geojson')
  .then(resp => {
    if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
    return resp.json();
  })
  .then(data => {
    if (!data || !data.features) throw new Error('Invalid GeoJSON data structure');
    
    allFeatures = data.features;
    grouped = {};
    
    allFeatures.forEach(f => {
      if (f.properties && f.geometry && f.geometry.coordinates) {
        const cat = f.properties.category || "Sonstiges";
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(f);
      } else {
        console.warn('Invalid feature found:', f);
      }
    });
    
    updateMarkers();
    buildCategoryList();
    injectPlacesJSONLD(allFeatures);
  })
  .catch(err => {
    console.error("GeoJSON konnte nicht geladen werden:", err);
    const container = document.getElementById('location-list');
    container.innerHTML = '<p style="color: red;">Daten konnten nicht geladen werden. Bitte versuchen Sie es sp√§ter erneut.</p>';
  });

const debouncedSearch = debounce((val) => {
  searchTerm = val;

  const q = (val || '').toLowerCase().trim();
  const categories = document.querySelectorAll('.category');
  const showAllBtn = document.getElementById('show-all-btn');

  let matchesTotal = 0;

  categories.forEach(category => {
    const entries = category.querySelectorAll('.location-entry');
    let matches = 0;

    entries.forEach(item => {
      const name = (item.textContent || '').toLowerCase();
      const show = !q || name.includes(q);
      item.style.display = show ? 'block' : 'none';
      if (show) matches++;
    });

    if (q) {
      if (matches > 0) {
        category.style.display = 'block';
        category.classList.add('active');    
      } else {
        category.style.display = 'none';
        category.classList.remove('active');
      }
    } else {
      category.style.display = 'block';
      category.classList.remove('active');
      entries.forEach(e => e.style.display = 'none');
    }

    matchesTotal += matches;
  });

  if (showAllBtn) showAllBtn.classList.toggle('active', !q);

  const container = document.getElementById('location-list');
  let empty = container.querySelector('.no-results');
  if (!q || matchesTotal > 0) {
    if (empty) empty.remove();
  } else {
    if (!empty) {
      empty = document.createElement('div');
      empty.className = 'no-results';
      empty.style.cssText = 'padding:8px 4px;color:#666;font-size:12px;';
      empty.textContent = (LANG === 'en') ? 'No results' : 'Keine Treffer';
      container.appendChild(empty);
    }
  }

  applyMapFilter();
}, 200);

const searchInput = document.getElementById('search');
if (searchInput) {
  searchInput.addEventListener('input', function () {
    debouncedSearch(this.value);
  });
}

</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const splash = document.getElementById('cc-splash');
  if (!splash) return;

  const logo = splash.querySelector('.cc-logo');
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  const showMs = reduce ? 250 : 450;
  const logoFadeMs = 360;  

  const hideSplash = () => {
    splash.classList.add('cc-out');

    setTimeout(() => {
      splash.remove();
    }, logoFadeMs);

    localStorage.setItem('cc_splash_seen','1');
  };

  const startOnceLoaded = () => setTimeout(hideSplash, showMs);

  if (logo && logo.complete && logo.naturalWidth > 0) {
    startOnceLoaded();
  } else if (logo) {
    logo.addEventListener('load', startOnceLoaded, { once: true });
    logo.addEventListener('error', () => {
      console.warn('Splash-Logo nicht gefunden:', logo.src);
      startOnceLoaded();
    }, { once: true });
  } else {
    startOnceLoaded();
  }
});
</script>


</body>
</html>
